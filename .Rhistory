mutate(freq = value/n) %>%
select(-value, -n, -LENGTH)
merge(length_df_long,
length_df_long %>% group_by(YEAR, variable, BIN) %>% summarise(n = sum(value)),
by = c('YEAR', 'variable', 'BIN')) %>%
## calculate frequencies and reshape table
mutate(freq = value/n,
variable = ifelse(variable == 'FEMALES', 1, 2)) %>%
select(-value, -n, -LENGTH)
## get total number of samples in each year/sex/bin combo
length_df_long1 <- merge(length_df_long,
length_df_long %>% group_by(YEAR, variable, BIN) %>% summarise(n = sum(value)),
by = c('YEAR', 'variable', 'BIN')) %>%
## calculate frequencies
mutate(freq = value/n,
variable = ifelse(variable == 'FEMALES', 1, 2)) %>%
select(-value, -n, -LENGTH)
length_df_long1 %>%
filter(variable == 1) %>%
pivot_wider(., id_cols = YEAR, names_from = BIN, values_from = freq)
length_df_long1 %>%
filter(variable == 1)
merge(length_df_long,
length_df_long %>% group_by(YEAR, variable, BIN) %>% summarise(n = sum(value)),
by = c('YEAR', 'variable', 'BIN'))
## get total number of samples in each year/sex/bin combo
length_df_long1 <- merge(length_df_long,
length_df_long %>% group_by(YEAR, variable, BIN) %>% summarise(n = sum(value)),
by = c('YEAR', 'variable', 'BIN')) %>%
## fill missing year combos
## calculate frequencies
mutate(freq = value/n,
variable = ifelse(variable == 'FEMALES', 1, 2)) %>%
select(-value, -n, -LENGTH) %>% head()
merge(length_df_long,
length_df_long %>% group_by(YEAR, variable, BIN) %>% summarise(n = sum(value)),
by = c('YEAR', 'variable', 'BIN')) %>%
## fill missing year combos
## calculate frequencies
mutate(freq = value/n,
variable = ifelse(variable == 'FEMALES', 1, 2)) %>%
select(-value, -n, -LENGTH) %>% head()
## get total number of samples in each year/sex/bin combo
length_df_long1 <- merge(length_df_long,
length_df_long %>% group_by(YEAR, variable, BIN) %>% summarise(n = sum(value)),
by = c('YEAR', 'variable', 'BIN')) %>%
## fill missing year combos
## calculate frequencies
mutate(freq = value/n,
variable = ifelse(variable == 'FEMALES', 1, 2)) %>%
select(-value, -n, -LENGTH) %>% #head()
complete(., YEAR, variable, BIN)%>%  head()
merge(length_df_long,
length_df_long %>% group_by(YEAR, variable, BIN) %>% summarise(n = sum(value)),
by = c('YEAR', 'variable', 'BIN')) %>%
## fill missing year combos
## calculate frequencies
mutate(freq = value/n,
variable = ifelse(variable == 'FEMALES', 1, 2)) %>%
select(-value, -n, -LENGTH) %>% #head()
complete(., YEAR, variable, BIN)%>%  head()
## get total number of samples in each year/sex/bin combo
length_df_long1 <- merge(length_df_long,
length_df_long %>% group_by(YEAR, variable, BIN) %>% summarise(n = sum(value)),
by = c('YEAR', 'variable', 'BIN')) %>%
## fill missing year combos
## calculate frequencies
mutate(freq = value/n,
variable = ifelse(variable == 'FEMALES', 1, 2)) %>%
select(-value, -n, -LENGTH) %>% #head()
complete(., YEAR, variable, BIN)%>%
mutate(freq = ifelse(is.na(freq),0,freq)) %>% head()
merge(length_df_long,
length_df_long %>% group_by(YEAR, variable, BIN) %>% summarise(n = sum(value)),
by = c('YEAR', 'variable', 'BIN')) %>%
## fill missing year combos
## calculate frequencies
mutate(freq = value/n,
variable = ifelse(variable == 'FEMALES', 1, 2)) %>%
select(-value, -n, -LENGTH) %>% #head()
complete(., YEAR, variable, BIN)%>%
mutate(freq = ifelse(is.na(freq),0,freq)) %>% head()
## get total number of samples in each year/sex/bin combo
length_df_long1 <- merge(length_df_long,
length_df_long %>% group_by(YEAR, variable, BIN) %>% summarise(n = sum(value)),
by = c('YEAR', 'variable', 'BIN')) %>%
## calculate frequencies
mutate(freq = value/n,
variable = ifelse(variable == 'FEMALES', 1, 2)) %>%
select(-value, -n, -LENGTH) %>%
## fill missing year combos
complete(., YEAR, variable, BIN)%>%
mutate(freq = ifelse(is.na(freq),0,freq)) %>% sample_n(20)
length_df_long1 %>%
filter(variable == 1) %>%
pivot_wider(., id_cols = YEAR, names_from = BIN, values_from = freq)
length_df_long1
## get total number of samples in each year/sex/bin combo
length_df_long1 <- merge(length_df_long,
length_df_long %>% group_by(YEAR, variable, BIN) %>% summarise(n = sum(value)),
by = c('YEAR', 'variable', 'BIN')) %>%
## calculate frequencies
mutate(freq = value/n,
variable = ifelse(variable == 'FEMALES', 1, 2)) %>%
select(-value, -n, -LENGTH)
## get total number of samples in each year/sex/bin combo
length_df_long1 <- merge(length_df_long,
length_df_long %>% group_by(YEAR, variable, BIN) %>% summarise(n = sum(value)),
by = c('YEAR', 'variable', 'BIN')) %>%
## calculate frequencies
mutate(freq = value/n,
variable = ifelse(variable == 'FEMALES', 1, 2)) %>%
select(-value, -n, -LENGTH) %>%
# ## fill missing year combos
# complete(., YEAR, variable, BIN)%>%
mutate(freq = ifelse(is.na(freq),0,freq)) %>%
sample_n(20)
length_df_long1
## get total number of samples in each year/sex/bin combo
length_df_long1 <- merge(length_df_long,
length_df_long %>% group_by(YEAR, variable, BIN) %>% summarise(n = sum(value)),
by = c('YEAR', 'variable', 'BIN')) %>%
## calculate frequencies
mutate(freq = value/n,
variable = ifelse(variable == 'FEMALES', 1, 2)) %>%
select(-value, -n, -LENGTH) %>%
# ## fill missing year combos
complete(., YEAR, variable, BIN) %>%
mutate(freq = ifelse(is.na(freq),0,freq)) %>%
sample_n(20)
length_df_long1
## get total number of samples in each year/sex/bin combo
length_df_long1 <- merge(length_df_long,
length_df_long %>% group_by(YEAR, variable, BIN) %>% summarise(n = sum(value)),
by = c('YEAR', 'variable', 'BIN')) %>%
## calculate frequencies
mutate(freq = value/n,
variable = ifelse(variable == 'FEMALES', 1, 2)) %>%
select(-value, -n, -LENGTH) %>%
# ## fill missing year combos
complete(., YEAR, variable, BIN) %>%
# mutate(freq = ifelse(is.na(freq),0,freq)) %>%
sample_n(20)
length_df_long1
length_df_long1 <- merge(length_df_long,
length_df_long %>% group_by(YEAR, variable, BIN) %>% summarise(n = sum(value)),
by = c('YEAR', 'variable', 'BIN')) %>%
## calculate frequencies
mutate(freq = value/n,
variable = ifelse(variable == 'FEMALES', 1, 2)) %>%
select(-value, -n, -LENGTH) %>%
# ## fill missing year combos
complete(., YEAR, variable, BIN)
length_df_long1
summary(length_df_long1)
length_df_long1 %>% filter(YEAR == 1984)
of samples in each year/sex/bin combo
length_df_long1 <- merge(length_df_long,
length_df_long %>% group_by(YEAR, variable, BIN) %>% summarise(n = sum(value)),
by = c('YEAR', 'variable', 'BIN'))
merge(length_df_long,
length_df_long %>% group_by(YEAR, variable, BIN) %>% summarise(n = sum(value)),
by = c('YEAR', 'variable', 'BIN'))
length_df_long %>%
group_by(YEAR, variable, BIN) %>%
summarise(n = sum(value))
merge(length_df_long,
length_df_long %>%
group_by(YEAR, variable, BIN) %>%
summarise(n = sum(value)),
by = c('YEAR', 'variable', 'BIN')) %>%
filter(YEAR == 1984)
merge(length_df_long,
length_df_long %>%
group_by(YEAR, variable, BIN) %>%
summarise(n = sum(value)),
by = c('YEAR', 'variable', 'BIN')) %>%
filter(YEAR == 1984 & BIN == 6)
merge(length_df_long,
length_df_long %>%
group_by(YEAR, variable, BIN) %>%
summarise(n = sum(value)),
by = c('YEAR', 'variable', 'BIN')) %>%
filter(YEAR == 1984 & BIN == 24)
length_df_long <- Length_df %>%
mutate(LENGTH = LENGTH/10) %>% ## convert to cm
select(YEAR,LENGTH,MALES,FEMALES) %>%
melt(., id = c("YEAR","LENGTH")) %>%
BIN_LEN_DATA(.,length.bins) %>%
select(-LENGTH)
merge(length_df_long,
length_df_long %>%
group_by(YEAR, variable, BIN) %>%
summarise(n = sum(value)),
by = c('YEAR', 'variable', 'BIN')) %>%
filter(YEAR == 1984 & BIN == 24)
Length_df %>%
mutate(LENGTH = LENGTH/10) %>% ## convert to cm
select(YEAR,LENGTH,MALES,FEMALES) %>%
melt(., id = c("YEAR","LENGTH")) %>%
BIN_LEN_DATA(.,length.bins)
length_df_long <- Length_df %>%
mutate(LENGTH = LENGTH/10) %>% ## convert to cm
select(YEAR,LENGTH,MALES,FEMALES) %>%
melt(., id = c("YEAR","LENGTH")) %>%
BIN_LEN_DATA(.,length.bins)
length_df_long
length_df_long <- Length_df %>%
mutate(LENGTH = LENGTH/10) %>% ## convert to cm
select(YEAR,LENGTH,MALES,FEMALES) %>%
melt(., id = c("YEAR","LENGTH")) %>%
BIN_LEN_DATA(.,length.bins) %>%
group_by(YEAR, variable, BIN) %>%
summarise(val = sum(value))
head(length_df_long)
length_df_long <- Length_df %>%
mutate(LENGTH = LENGTH/10) %>% ## convert to cm
select(YEAR,LENGTH,MALES,FEMALES) %>%
melt(., id = c("YEAR","LENGTH")) %>%
BIN_LEN_DATA(.,length.bins) %>%
group_by(YEAR, variable, BIN) %>%
summarise(nobs = sum(value))
SSplotData(mod17)
length_df_long <- Length_df %>%
mutate(LENGTH = LENGTH/10) %>% ## convert to cm
select(YEAR,LENGTH,MALES,FEMALES) %>%
melt(., id = c("YEAR","LENGTH")) %>%
BIN_LEN_DATA(.,length.bins) %>%
group_by(YEAR, variable, BIN) %>%
## combine observations within length bins
summarise(nobs = sum(value))
merge(length_df_long,
length_df_long %>%
group_by(YEAR) %>%
## denominator is total number of samples this year
summarise(nsamp = sum(nobs)),
by = c('YEAR', 'variable', 'BIN'))
length_df_long %>%
group_by(YEAR) %>%
## denominator is total number of samples this year
summarise(nsamp = sum(nobs))
merge(length_df_long,
length_df_long %>%
group_by(YEAR) %>%
## denominator is total number of samples this year
summarise(nsamp = sum(nobs)),
by = c('YEAR'))
merge(length_df_long,
length_df_long %>%
group_by(YEAR) %>%
## denominator is total number of samples this year
summarise(nsamp = sum(nobs)),
by = c('YEAR')) %>%
# filter(YEAR == 1984 & BIN == 24)
## calculate frequencies
mutate(freq = value/n,
variable = ifelse(variable == 'FEMALES', 1, 2)) %>%
select(-value, -n, -LENGTH) %>%
# ## fill missing year combos
complete(., YEAR, variable, BIN) %>%
# mutate(freq = ifelse(is.na(freq),0,freq)) %>%
sample_n(20)
merge(length_df_long,
length_df_long %>%
group_by(YEAR) %>%
## denominator is total number of samples this year
summarise(nsamp = sum(nobs)),
by = c('YEAR')) %>%
# filter(YEAR == 1984 & BIN == 24)
## calculate frequencies
mutate(freq = value/nsamp,
variable = ifelse(variable == 'FEMALES', 1, 2)) %>%
select(-value, -nsamp, -LENGTH) %>%
# ## fill missing year combos
complete(., YEAR, variable, BIN) %>%
# mutate(freq = ifelse(is.na(freq),0,freq)) %>%
sample_n(20)
merge(length_df_long,
length_df_long %>%
group_by(YEAR) %>%
## denominator is total number of samples this year
summarise(nsamp = sum(nobs)),
by = c('YEAR')) %>%
# filter(YEAR == 1984 & BIN == 24)
## calculate frequencies
mutate(freq = nobs/nsamp,
variable = ifelse(variable == 'FEMALES', 1, 2)) %>%
select(-nobs, -nsamp, -LENGTH) %>%
# ## fill missing year combos
complete(., YEAR, variable, BIN) %>%
# mutate(freq = ifelse(is.na(freq),0,freq)) %>%
sample_n(20)
merge(length_df_long,
length_df_long %>%
group_by(YEAR) %>%
## denominator is total number of samples this year
summarise(nsamp = sum(nobs)),
by = c('YEAR')) %>%
# filter(YEAR == 1984 & BIN == 24)
## calculate frequencies
mutate(freq = nobs/nsamp,
variable = ifelse(variable == 'FEMALES', 1, 2))
merge(length_df_long,
length_df_long %>%
group_by(YEAR) %>%
## denominator is total number of samples this year
summarise(nsamp = sum(nobs)),
by = c('YEAR')) %>%
# filter(YEAR == 1984 & BIN == 24)
## calculate frequencies
mutate(freq = nobs/nsamp,
variable = ifelse(variable == 'FEMALES', 1, 2)) %>%
select(-nobs, -nsamp) %>%
# ## fill missing year combos
complete(., YEAR, variable, BIN) %>%
# mutate(freq = ifelse(is.na(freq),0,freq)) %>%
sample_n(20)
merge(length_df_long,
length_df_long %>%
group_by(YEAR) %>%
## denominator is total number of samples this year
summarise(nsamp = sum(nobs)),
by = c('YEAR')) %>%
# filter(YEAR == 1984 & BIN == 24)
## calculate frequencies
mutate(freq = nobs/nsamp,
variable = ifelse(variable == 'FEMALES', 1, 2)) %>%
select(-nobs, -nsamp) %>%
# ## fill missing year combos
complete(., YEAR, variable, BIN) %>%
# mutate(freq = ifelse(is.na(freq),0,freq)) %>%
sample_n(100)
merge(length_df_long,
length_df_long %>%
group_by(YEAR) %>%
## denominator is total number of samples this year
summarise(nsamp = sum(nobs)),
by = c('YEAR')) %>%
# filter(YEAR == 1984 & BIN == 24)
## calculate frequencies
mutate(freq = nobs/nsamp,
variable = ifelse(variable == 'FEMALES', 1, 2)) %>%
select(-nobs, -nsamp)
merge(length_df_long,
length_df_long %>%
group_by(YEAR) %>%
## denominator is total number of samples this year
summarise(nsamp = sum(nobs)),
by = c('YEAR')) %>%
# filter(YEAR == 1984 & BIN == 24)
## calculate frequencies
mutate(freq = nobs/nsamp,
variable = ifelse(variable == 'FEMALES', 1, 2)) %>%
select(-nobs, -nsamp) %>%
# ## fill missing year combos
complete(., YEAR, variable, BIN) %>%
# mutate(freq = ifelse(is.na(freq),0,freq)) %>%
sample_n(500)
?arrange
## get total number of samples in each year/sex/bin combo
length_df_long1 <- merge(length_df_long,
length_df_long %>%
group_by(YEAR) %>%
## denominator is total number of samples this year
summarise(nsamp = sum(nobs)),
by = c('YEAR')) %>%
# filter(YEAR == 1984 & BIN == 24)
## calculate frequencies
mutate(freq = nobs/nsamp,
variable = ifelse(variable == 'FEMALES', 1, 2)) %>%
select(-nobs, -nsamp) %>%
# ## fill missing year combos
complete(., YEAR, variable, BIN) %>%
arrange(., YEAR, BIN, variable)
merge(length_df_long,
length_df_long %>%
group_by(YEAR) %>%
## denominator is total number of samples this year
summarise(nsamp = sum(nobs)),
by = c('YEAR')) %>%
# filter(YEAR == 1984 & BIN == 24)
## calculate frequencies
mutate(freq = nobs/nsamp,
variable = ifelse(variable == 'FEMALES', 1, 2)) %>%
select(-nobs, -nsamp) %>%
# ## fill missing year combos
complete(., YEAR, variable, BIN) %>%
arrange(., YEAR, BIN, variable)
## get total number of samples in each year/sex/bin combo
length_df_long1 <- merge(length_df_long,
length_df_long %>%
group_by(YEAR) %>%
## denominator is total number of samples this year
summarise(nsamp = sum(nobs)),
by = c('YEAR')) %>%
# filter(YEAR == 1984 & BIN == 24)
## calculate frequencies
mutate(freq = nobs/nsamp,
variable = ifelse(variable == 'FEMALES', 1, 2)) %>%
select(-nobs, -nsamp) %>%
# ## fill missing year combos
complete(., YEAR, variable, BIN) %>%
arrange(., YEAR, BIN, variable) %>%
mutate(freq = ifelse(is.na(freq),0,freq))
length_df_long1
## get total number of samples in each year/sex/bin combo
length_df_long1 <- merge(length_df_long,
length_df_long %>%
group_by(YEAR) %>%
## denominator is total number of samples this year
summarise(nsamp = sum(nobs)),
by = c('YEAR')) %>%
# filter(YEAR == 1984 & BIN == 24)
## calculate frequencies
mutate(freq = nobs/nsamp,
variable = ifelse(variable == 'FEMALES', 1, 2)) %>%
select(-nobs, -nsamp) %>%
# ## fill missing year combos
complete(., YEAR, variable, BIN) %>%
arrange(., YEAR, BIN, variable) %>%
mutate(freq = ifelse(is.na(freq),0,freq))
length_df_long1 %>%
filter(variable == 1) %>%
pivot_wider(., id_cols = YEAR, names_from = BIN, values_from = freq)
frontmatter = data.frame(length_df_long1$YEAR, month = 7, fleet = 2, sex = 3, part = 0, Nsamp = NA)
frontmatter <- data.frame(length_df_long1$YEAR, month = 7, fleet = 2, sex = 3, part = 0, Nsamp = NA)
length_df_long1 %>%
filter(variable == 1) %>%
pivot_wider(., id_cols = YEAR, names_from = BIN, values_from = freq) %>%
select(-YEAR)
cbind(frontmatter,
length_df_long1 %>%
filter(variable == 1) %>%
pivot_wider(., id_cols = YEAR, names_from = BIN, values_from = freq) %>%
select(-YEAR),
length_df_long1 %>%
filter(variable == 2) %>%
pivot_wider(., id_cols = YEAR, names_from = BIN, values_from = freq) %>%
select(-YEAR)
cbind(frontmatter,
length_df_long1 %>%
filter(variable == 1) %>%
pivot_wider(., id_cols = YEAR, names_from = BIN, values_from = freq) %>%
select(-YEAR),
length_df_long1 %>%
filter(variable == 2) %>%
pivot_wider(., id_cols = YEAR, names_from = BIN, values_from = freq) %>%
select(-YEAR))
survey_length_comps <- cbind(frontmatter,
length_df_long1 %>%
filter(variable == 1) %>%
pivot_wider(., id_cols = YEAR, names_from = BIN, values_from = freq) %>%
select(-YEAR),
length_df_long1 %>%
filter(variable == 2) %>%
pivot_wider(., id_cols = YEAR, names_from = BIN, values_from = freq) %>%
select(-YEAR))
dim(survey_length_comps)
frontmatter <- data.frame(length_df_long1$YEAR, month = 7, fleet = 2, sex = 3, part = 0, Nsamp = NA)
dim(length_df_long1 %>%
filter(variable == 1) %>%
pivot_wider(., id_cols = YEAR, names_from = BIN, values_from = freq) )
dim(length_df_long1 %>%
filter(variable == 2) %>%
pivot_wider(., id_cols = YEAR, names_from = BIN, values_from = freq) %>%
select(-YEAR))
dim(frontmatter)
frontmatter <- data.frame(unique(length_df_long1$YEAR), month = 7, fleet = 2, sex = 3, part = 0, Nsamp = NA)
frontmatter
frontmatter <- data.frame(yr = unique(length_df_long1$YEAR), month = 7, fleet = 2, sex = 3, part = 0, Nsamp = NA)
frontmatter
area
area
## nsamp query
## The survey sample size (nhauls) was derived using W Paullson's source("C:\\GitProjects\\newsbss\\Get_GOA_Survey_Length_and_Age_Comp\\Get_Survey_Length_Age_Stats.R")
the.l.query<-paste0("SELECT c.YEAR,\n ",
"l.SPECIES_CODE,\n ",
"c.HAULJOIN,\n ",
"l.LENGTH,\n ",
"l.FREQUENCY,\n ",
"l.SEX\n ",
"FROM racebase.length l,\n ",
"goa.cpue c\n ",
"WHERE l.HAULJOIN     = c.HAULJOIN\n ",
"AND l.CATCHJOIN      = c.CATCHJOIN\n ",
"AND l.REGION         = c.SURVEY\n ",
"AND (l.SPECIES_CODE IN (",species,")\n ",
"AND l.REGION         = ",sp_area,")\n ",
"GROUP BY c.YEAR,\n ",
"  l.SPECIES_CODE,\n ",
"  c.HAULJOIN,\n ",
"  l.LENGTH,\n ",
"  l.FREQUENCY,\n ",
"  l.SEX\n ",
"ORDER BY l.species_code,\n ",
"  c.YEAR")
thedata=sqlQuery(AFSC,the.l.query)
# Packages and RODBC setup ----
require(RODBC)
require(dplyr)
require(here)
require(ggplot2); require(ggsidekick)
require(r4ss)
require(reshape2)
newsbssdir <- "C:/Users/maia.kapur/Work/assessments/newsbss/"
AFSC <- odbcConnect("AFSC","mkapur","mkq!Pw4N5w",  believeNRows = FALSE)
AKFIN <- odbcConnect("AKFIN","mkapur","ssmamk22",  believeNRows=FALSE)
species <- 10130 #throughout make sure the SpeciesCode = 10130 for the survey, 103 for observer data
sp_area <- "'GOA'"
fyear <- 2022
thedata <- sqlQuery(AFSC,the.l.query)
thedata$ID <-thedata$HAULJOIN
