select(Yr, Sex, Nsamp_in, Lbin_lo, Bin, obs2)
subset(AL_df_wide,yr == 2015 & sex == 2 &  Lbin_lo  == 24)
mod17$condbase %>% filter(Fleet == 2 & Sex == 2 & Yr == 2015
& Bin == 24
& Lbin_lo  == 36
) %>%
mutate(obs2 = round(Obs*Nsamp_in,0)) %>%
select(Yr, Sex, Nsamp_in, Lbin_lo, Bin, obs2)
mod17$condbase %>% filter(Fleet == 2 & Sex == 2 & Yr == 2015
& Bin == 24
& Lbin_lo  == 36
)
mod17$condbase %>% filter(Fleet == 2 & Sex == 2 & Yr == 2015
& Bin == 5
& Lbin_lo  == 24
) %>%
mutate(obs2 = round(Obs*Nsamp_in,0)) %>%
select(Yr, Sex, Nsamp_in, Lbin_lo, Bin, obs2)
subset(AL_df_wide,yr == 2015 & sex == 2 &  Lbin_lo  == 24)
write.csv(Final.df,file = here('data','comp',paste0(Sys.Date(),'-goa_CAAL_forSS.csv')),row.names = FALSE)
## disable data before 1990
AL_df_wide$fleet[AL_df_wide$yr < 1990] <- -2
write.csv(Final.df,file = here('data','comp',paste0(Sys.Date(),'-goa_CAAL_forSS.csv')),row.names = FALSE)
MyQuery<-paste0("SELECT GOA.AGECOMP_TOTAL.SURVEY,\n ",
"GOA.AGECOMP_TOTAL.SURVEY_YEAR,\n ",
"GOA.AGECOMP_TOTAL.SPECIES_CODE,\n ",
"GOA.AGECOMP_TOTAL.AGE,\n ",
"GOA.AGECOMP_TOTAL.SEX,\n ",
"GOA.AGECOMP_TOTAL.AGEPOP\n",
"FROM GOA.AGECOMP_TOTAL\n ",
"WHERE GOA.AGECOMP_TOTAL.SURVEY     =", sp_area,"\n ",
"AND GOA.AGECOMP_TOTAL.SPECIES_CODE = ",species)
write.csv(AL_df,file = here('data','comp',paste0(Sys.Date(),'-goa_CAAL_raw.csv')),row.names = FALSE)
MyQuery<-paste0("SELECT GOA.AGECOMP_TOTAL.SURVEY,\n ",
"GOA.AGECOMP_TOTAL.SURVEY_YEAR,\n ",
"GOA.AGECOMP_TOTAL.SPECIES_CODE,\n ",
"GOA.AGECOMP_TOTAL.AGE,\n ",
"GOA.AGECOMP_TOTAL.SEX,\n ",
"GOA.AGECOMP_TOTAL.AGEPOP\n",
"FROM GOA.AGECOMP_TOTAL\n ",
"WHERE GOA.AGECOMP_TOTAL.SURVEY     =", sp_area,"\n ",
"AND GOA.AGECOMP_TOTAL.SPECIES_CODE = ",species)
AgeComp.df<-sqlQuery(AFSC,MyQuery)
species <- 10130 #throughout make sure the SpeciesCode = 10130 for the survey, 103 for observer data
sp_area <- "'GOA'"
fyear <- 2022
MyQuery<-paste0("SELECT GOA.AGECOMP_TOTAL.SURVEY,\n ",
"GOA.AGECOMP_TOTAL.SURVEY_YEAR,\n ",
"GOA.AGECOMP_TOTAL.SPECIES_CODE,\n ",
"GOA.AGECOMP_TOTAL.AGE,\n ",
"GOA.AGECOMP_TOTAL.SEX,\n ",
"GOA.AGECOMP_TOTAL.AGEPOP\n",
"FROM GOA.AGECOMP_TOTAL\n ",
"WHERE GOA.AGECOMP_TOTAL.SURVEY     =", sp_area,"\n ",
"AND GOA.AGECOMP_TOTAL.SPECIES_CODE = ",species)
AgeComp.df<-sqlQuery(AFSC,MyQuery)
AgeComp.df<-AgeComp.df[AgeComp.df$AGE >=0 & AgeComp.df$SEX <3,]
write.csv(AgeComp.df,file = here('data','comp',paste0(Sys.Date(),"-goa_marginal_agecomp_raw.csv")),rownames = FALSE)
write.csv(AgeComp.df,file = here('data','comp',paste0(Sys.Date(),"-goa_marginal_agecomp_raw.csv")),row.names = FALSE)
#Bin ages
AgeComp.df<-BIN_AGE_DATA(AgeComp.df,age_bins = AgeBins)
#Make into proportions that sum to 1 over males + females
Ages.df<-aggregate(AGEPOP ~ SURVEY_YEAR + SEX + aBIN,AgeComp.df,sum)
SumAges.df<-aggregate(AGEPOP ~ SURVEY_YEAR,AgeComp.df,sum)
SumAges.df$SumOverA<-SumAges.df$AGEPOP
names(AgeComp.df)
head(AgeComp.df)
age_bins
#Bin ages
AgeComp.df<-BIN_AGE_DATA(AgeComp.df,age_bins)
#Make into proportions that sum to 1 over males + females
Ages.df<-aggregate(AGEPOP ~ SURVEY_YEAR + SEX + aBIN,AgeComp.df,sum)
SumAges.df<-aggregate(AGEPOP ~ SURVEY_YEAR,AgeComp.df,sum)
SumAges.df$SumOverA<-SumAges.df$AGEPOP
SumAges.df<-subset(SumAges.df,select = -c(AGEPOP))
Ages.df<-merge(Ages.df,SumAges.df,all=TRUE)
Ages.df$Proportion<-Ages.df$AGEPOP/Ages.df$SumOverA
Ages.df<-subset(Ages.df,select = -c(SumOverA,AGEPOP))
#Flip to SS format
Ages.df$SexNum<-as.numeric(Ages.df$SEX==1) #males
Ages.df$SexAge<-as.numeric(paste0(Ages.df$SexNum,0,Ages.df$aBIN))
FlipComp1.df<-dcast(Ages.df,SURVEY_YEAR ~ SexAge,sum,value.var = "Proportion") #this isn't really summing anything, or shouldn't be. Just transposing. Function is not at all straightforward
nms<-c(AgeBins,paste0("10",AgeBins))
Missing<-setdiff(nms,names(FlipComp1.df))
FlipComp1.df[Missing]<-0
FlipComp1.df<-FlipComp1.df[,c("SURVEY_YEAR",nms)]
FlipComp1.df
## nsamp query
## The survey sample size (nhauls) was derived using W Paullson's code.
## Carey indicates that lengths only come from "good" hauls anyway,
## though I notice these values vary slightly (about 5 hauls) from what was used in 2017.
## source("C:\\GitProjects\\newsbss\\Get_GOA_Survey_Length_and_Age_Comp\\Get_Survey_Length_Age_Stats.R")
hauljoin_query <-paste0("SELECT c.YEAR,\n ",
"l.SPECIES_CODE,\n ",
"c.HAULJOIN,\n ",
"l.LENGTH,\n ",
"l.FREQUENCY,\n ",
"l.SEX\n ",
"FROM racebase.length l,\n ",
"goa.cpue c\n ",
"WHERE l.HAULJOIN     = c.HAULJOIN\n ",
"AND l.CATCHJOIN      = c.CATCHJOIN\n ",
"AND l.REGION         = c.SURVEY\n ",
"AND (l.SPECIES_CODE IN (",species,")\n ",
"AND l.REGION         = ",sp_area,")\n ",
"GROUP BY c.YEAR,\n ",
"  l.SPECIES_CODE,\n ",
"  c.HAULJOIN,\n ",
"  l.LENGTH,\n ",
"  l.FREQUENCY,\n ",
"  l.SEX\n ",
"ORDER BY l.species_code,\n ",
"  c.YEAR")
hauljoin <- sqlQuery(AFSC,hauljoin_query)
## for each year, sum the nhauls. Wayne's code also does this for males and females, but this is all  we need for SS.
nhauls <- hauljoin %>%
group_by(YEAR) %>%
summarise(nhaul = n_distinct(ID))
nhauls <- hauljoin %>%
group_by(YEAR) %>%
summarise(nhaul = n_distinct(ID))
write.csv(nhauls, here('data','comp',paste0(Sys.Date(),"-survey_nhauls.csv"), row.names = FALSE))
hauljoin
hauljoin %>%
group_by(YEAR) %>%
summarise(nhaul = n_distinct(ID))
head(hauljoin)
## for each year, sum the nhauls. Wayne's code also does this for males and females, but this is all we need for SS.
nhauls <- hauljoin %>%
group_by(YEAR) %>%
summarise(nhaul = n_distinct(HAULJOIN))
nhauls
write.csv(nhauls, here('data','comp',paste0(Sys.Date(),"-survey_nhauls.csv"), row.names = FALSE))
write.csv(nhauls, here('data','comp',paste0(Sys.Date(),"-survey_nhauls.csv")), row.names = FALSE))
write.csv(nhauls, here('data','comp',paste0(Sys.Date(),"-survey_nhauls.csv")), row.names = FALSE)
head(FlipComp1.df)
#Hauls come separately from above, make sure you're using the right ones
merge(FlipComp1.df, nhauls, by.x = 'SURVEY_YEAR', by.y = 'YEAR')
head(AL_df_wide)
summary(FlipComp1.df)
FlipComp1.df
names(AL_df_wide)
nhauls
merge(FlipComp1.df, nhauls, by.x = 'SURVEY_YEAR', by.y = 'YEAR') %>%
mutate(month = 7, fleet = 2, sex = 3, part = 0, ageerr = 1, Lbin_lo = -1, Lbin_hi = -1 )
#Hauls come separately from above, make sure you're using the right ones
merge(FlipComp1.df, nhauls, by.x = 'SURVEY_YEAR', by.y = 'YEAR') %>%
mutate(month = 7, fleet = 2, sex = 3, part = 0, ageerr = 1, Lbin_lo = -1, Lbin_hi = -1 ) %>%
select(yr = SURVEY_YEAR, month, fleet, sex, part, ageerr, Lbin_lo, Lbin_hi, Nsamp= nhaul, everything())
#Hauls come separately from above, make sure you're using the right ones
goa_marginals <- merge(FlipComp1.df, nhauls, by.x = 'SURVEY_YEAR', by.y = 'YEAR') %>%
mutate(month = 7, fleet = 2, sex = 3, part = 0, ageerr = 1, Lbin_lo = -1, Lbin_hi = -1 ) %>%
select(yr = SURVEY_YEAR, month, fleet, sex, part, ageerr, Lbin_lo, Lbin_hi, Nsamp= nhaul, everything())
goa_marginals
write.csv(goa_marginals,file = here('data','comp',paste0(Sys.Date(),"-goa_marginal_agecomp_forSS.csv")),rownames = FALSE)
write.csv(goa_marginals,file = here('data','comp',paste0(Sys.Date(),"-goa_marginal_agecomp_forSS.csv")),row.names = FALSE)
m0_0 <- SS_output(here('model_runs','m0_0'), covar=TRUE, verbose=FALSE, printstats=FALSE)
m0_0check <- SS_output(here('model_runs','m0_0check'), covar=TRUE, verbose=FALSE, printstats=FALSE)
SSplotComparisons(SSsummarize(list(m0_0,m0_0check)),  uncertainty=TRUE, subplot = 1, legendlabels = models[c(1,2,5)])
models = c('m0_0','m0_0check')
SSplotComparisons(SSsummarize(list(m0_0,m0_0check)),  uncertainty=TRUE, subplot = 1, legendlabels = models)
?SSplotComparisons
SSplotComparisons(SSsummarize(list(m0_0,m0_0check)),  uncertainty=TRUE, subplot = 11, legendlabels = models)
SSplotComparisons(SSsummarize(list(m0_0,m0_0check)),  uncertainty=TRUE, subplot = 1, legendlabels = models)
m0_0$parameters
m0_0$parameters[which(m0_0$parameters$Init)>m0_0$parameters$Max]
m0_0$parameters[which(m0_0$parameters$Init)>m0_0$parameters$Max)]
m0_0$parameters[which(m0_0$parameters$Init>m0_0$parameters$Max)]
m0_0$parameters[which(m0_0$parameters$Init>m0_0$parameters$Max),]
models = c('m0_0','m0_1')
m0_0check <- SS_output(here('model_runs','m0_1'), covar=TRUE, verbose=FALSE, printstats=FALSE)
m0_1 <- SS_output(here('model_runs','m0_1'), covar=TRUE, verbose=FALSE, printstats=FALSE)
SSplotComparisons(SSsummarize(list(m0_0,m0_0check)),  uncertainty=TRUE, subplot = 1, legendlabels = models)
SSplotComparisons(SSsummarize(list(m0_0,m0_0check)),  uncertainty=TRUE, subplot = 11, legendlabels = models)
SSplotCatch(m0_1)
SSplotComparisons(SSsummarize(list(m0_0,m0_0check)),  uncertainty=TRUE, subplot = 11, legendlabels = models)
models = c('m0_0','+catch', '+survey')
SS_plots(m0_1)
SS_plots(m0_1, plot = FALSE, print = T, plotdir = here('model_runs','m0_1'))
SS_plots(m0_1, plot = FALSE, png = T, plotdir = here('model_runs','m0_1'))
SS_plots(m0_2, plot = FALSE, png = T, plotdir = here('model_runs','m0_1'))
models = c('m0_0','+catch', '+survey', '+lengths','+CAAL')
m0_2 <- SS_output(here('model_runs','m0_2'), covar=TRUE, verbose=FALSE, printstats=FALSE)
SS_plots(m0_2, plot = FALSE, png = T, plotdir = here('model_runs','m0_2'))
SS_plots(m0_1, plot = F,print = T, png = T, plotdir = here('model_runs','m0_1'))
SS_plots(m0_1, plot = F,  png = T, plotdir = here('model_runs','m0_1'))
graphics.off()
SS_plots(m0_1, plot = F,  png = T, plotdir = here('model_runs','m0_1'))
SS_plots(m0_2, plot = FALSE, png = T, plotdir = here('model_runs','m0_2'))
?SSplotComparisons
SSplotComparisons(SSsummarize(list(m0_0,m0_1,m0_2)),  plot = FALSE, png = T, plotdir = here('model_runs','m0_2'), uncertainty=TRUE,  legendlabels = models)
SSplotComparisons(SSsummarize(list(m0_0,m0_1 )),  plot = FALSE, png = T, plotdir = here('model_runs','m0_1'), uncertainty=TRUE,  legendlabels = models)
#* spot check fishery lcomps ----
## should be within rounding range
mod17$lendbase %>%
filter(Fleet == 1 & Yr == 2001 & Bin == 46 & Sex == 1) %>%
select(Obs) %>% round(.,4) ==
round(fishery_length_comps[19,'46'],4)
#* length comps----
#** fishery length comps ----
# data ommitted in 1982:1988,2000, 2008 because less than 15 hauls
## these are presented as straight up numbers (though unclear how these are decimals); the nhauls are a separate value
## Get_Fishery_Lengths_With_Extrapolated_Number.R
## Go query domestic (DLCOMP) and foreign (FLCOMP) fishery length information from OBSINT and NORPAQ
## Using extrapolated number (and the equivalent from foreign data), calculate population-level
## length comps in terms of numbers return a dataframe with those comps (comps) as well as the total population numbers
## summed over males, females, and length bins for later use (totals)
## it does not appear that unsexed values were used, nor was gear considered in the frequency calculation
fish_lcomp0 <- rbind(GET_CATCH_AT_SIZE_PIECES(type="D",fsh_sp_str=103,sp_area,len_bins=length_bins,bin=TRUE),
GET_CATCH_AT_SIZE_PIECES(type="F",fsh_sp_str=103,sp_area,len_bins=length_bins,bin=TRUE)) %>%
filter(SEX != 'U')
#Nsamp for Fishery lengths (and tables for the SAFE):
#Get_Fishery_Length_HaulStats_With_NORPAQ.R"
low.nmfs.area = "'600'" #"'600'" #500
hi.nmfs.area = "'699'" #"'699'"  #544
## foreign fishery nhauls from NORPAQ (>= 1989)
Fnhaul_query <-paste0("SELECT NORPAC.FOREIGN_LENGTH.SPECIES,\n ",
"NORPAC.FOREIGN_LENGTH.SEX,\n ",
"NORPAC.FOREIGN_LENGTH.YEAR,\n ",
"NORPAC.FOREIGN_LENGTH.FREQUENCY,\n ",
"NORPAC.FOREIGN_HAUL.GENERIC_AREA,\n ",
"NORPAC.FOREIGN_LENGTH.SIZE_GROUP,\n ",
"NORPAC.FOREIGN_HAUL.HAUL_JOIN,\n ",
"NORPAC.FOREIGN_HAUL.HOOKS_PER_SKATE,\n ",
"NORPAC.FOREIGN_HAUL.NUMBER_OF_POTS\n ",
"FROM NORPAC.FOREIGN_LENGTH\n ",
"INNER JOIN NORPAC.FOREIGN_HAUL\n ",
"ON NORPAC.FOREIGN_HAUL.HAUL_JOIN    = NORPAC.FOREIGN_LENGTH.HAUL_JOIN\n ",
"WHERE NORPAC.FOREIGN_LENGTH.SPECIES = ",103,"\n ",
"AND NORPAC.FOREIGN_HAUL.GENERIC_AREA BETWEEN ",low.nmfs.area," AND ",hi.nmfs.area)
hauljoin <- sqlQuery(AFSC,Fnhaul_query)
hauljoin <-hauljoin[hauljoin$GENERIC_AREA!=670,]
hauljoin$ID<-hauljoin$HAUL_JOIN
## for each year, sum the nhauls. Wayne's code also does this for males and females, but this is all  we need for SS.
nhauls_for <- hauljoin %>%
group_by(YEAR) %>%
summarise(nhaul = n_distinct(ID))
## domestic fishery nhauls from NORPAQ (>= 1989)
Dnhaul_query <-paste0("SELECT OBSINT.DEBRIEFED_LENGTH.HAUL_JOIN,\n ",
"OBSINT.DEBRIEFED_LENGTH.SPECIES,\n ",
"OBSINT.DEBRIEFED_LENGTH.SEX,\n ",
"OBSINT.DEBRIEFED_LENGTH.LENGTH,\n ",
"OBSINT.DEBRIEFED_LENGTH.FREQUENCY,\n ",
"OBSINT.DEBRIEFED_LENGTH.CRUISE,\n ",
"OBSINT.DEBRIEFED_LENGTH.PERMIT,\n ",
"OBSINT.DEBRIEFED_LENGTH.GEAR_PERFORMANCE,\n ",
"OBSINT.DEBRIEFED_LENGTH.YEAR,\n ",
"OBSINT.DEBRIEFED_LENGTH.GEAR,\n ",
"OBSINT.DEBRIEFED_LENGTH.NMFS_AREA,\n ",
"OBSINT.DEBRIEFED_LENGTH.HAUL_OFFLOAD,\n ",
"OBSINT.DEBRIEFED_HAUL.HAUL_SEQ,\n ",
"SUBSTR(TO_CHAR(OBSINT.DEBRIEFED_LENGTH.HAUL_JOIN),9,19) AS LAST1,\n ",
"SUBSTR(TO_CHAR(OBSINT.DEBRIEFED_LENGTH.HAUL_JOIN),1,8) AS FIRST1\n ",
"FROM OBSINT.DEBRIEFED_LENGTH\n ",
"INNER JOIN OBSINT.DEBRIEFED_HAUL\n ",
"ON OBSINT.DEBRIEFED_HAUL.HAUL_JOIN    = OBSINT.DEBRIEFED_LENGTH.HAUL_JOIN\n ",
"WHERE OBSINT.DEBRIEFED_LENGTH.SPECIES = ",103,"\n ",
"AND OBSINT.DEBRIEFED_LENGTH.NMFS_AREA BETWEEN ",low.nmfs.area," AND ",hi.nmfs.area)
hauljoin <- sqlQuery(AFSC,nhaul_query)
hauljoin <-hauljoin[hauljoin$NMFS_AREA!=670,]
hauljoin$ID<-paste0(hauljoin$FIRST1,hauljoin$LAST1)
## for each year, sum the nhauls. Wayne's code also does this for males and females, but this is all  we need for SS.
nhauls_dom <- hauljoin %>%
group_by(YEAR) %>%
summarise(nhaul = n_distinct(ID))
hauljoin <- sqlQuery(AFSC,Dnhaul_query)
hauljoin <-hauljoin[hauljoin$NMFS_AREA!=670,]
hauljoin$ID<-paste0(hauljoin$FIRST1,hauljoin$LAST1)
## for each year, sum the nhauls. Wayne's code also does this for males and females, but this is all  we need for SS.
nhauls_dom <- hauljoin %>%
group_by(YEAR) %>%
summarise(nhaul = n_distinct(ID))
fish_lcomp <- fish_lcomp0 %>%
group_by(YEAR, LENGTH, SEX) %>%
#1988-1990 are in both foreign and domestic and represent different fisheries at that time
#Add length frequencies for years where both foreign and domestic fisheries were operating:
summarise(nobs = sum(LNUMBERS))
## get total number of samples in each year/sex/bin combo
length_df_long1 <- merge(fish_lcomp,
fish_lcomp %>%
group_by(YEAR) %>%
## denominator is total number of samples this year
summarise(nsamp = sum(nobs)),
by = c('YEAR')) %>%
## calculate frequencies
mutate(freq = nobs/nsamp,
variable = ifelse(SEX == 'F', 1, 2)) %>%
select(-nobs, -nsamp, -SEX) %>%
# ## fill missing year combos
tidyr::complete(., YEAR, variable, LENGTH ) %>%
arrange(., YEAR, LENGTH, variable) %>%
mutate(freq = ifelse(is.na(freq),0,freq))
frontmatter <- data.frame(yr = unique(length_df_long1$YEAR), month = 7, fleet = 1,
sex = 3, part = 0, Nsamp = c(nhauls_for$nhaul, nhauls_dom$nhaul))
## turn off fleets
frontmatter$fleet[frontmatter$yr %in% c(1982:1988,2000,2008)] <- -1
fishery_length_comps <- cbind(frontmatter,
length_df_long1 %>%
filter(variable == 1) %>%
pivot_wider(., id_cols = YEAR, names_from = LENGTH, values_from = freq) %>%
select(-YEAR),
length_df_long1 %>%
filter(variable == 2) %>%
pivot_wider(., id_cols = YEAR, names_from = LENGTH,values_from = freq) %>%
select(-YEAR))
#* spot check fishery lcomps ----
## should be within rounding range
mod17$lendbase %>%
filter(Fleet == 1 & Yr == 2001 & Bin == 46 & Sex == 1) %>%
select(Obs) %>% round(.,4) ==
round(fishery_length_comps[19,'46'],4)
mod17$lendbase %>%
filter(Fleet == 1 & Yr == 2001 & Bin == 46 & Sex == 1) %>%
select(Obs) %>% round(.,4)
round(fishery_length_comps[19,'46'],4)
m0_3 <- SS_output(here('model_runs','m0_3'), covar=TRUE, verbose=FALSE, printstats=FALSE)
SS_plots(m0_3, plot = FALSE, png = T, plotdir = here('model_runs','m0_2'))
SSplotComparisons(SSsummarize(list(m0_0,m0_1,m0_2,m0_3)),  plot = FALSE, png = T, plotdir = here('model_runs','m0_3'), uncertainty=TRUE,  legendlabels = models)
SS_plots(m0_3, plot = FALSE, png = T, plotdir = here('model_runs','m0_3'))
SS_plots(m0_2, plot = FALSE, png = T, plotdir = here('model_runs','m0_2'))
here('model_runs','m0_3')
SS_plots(m0_3, plot = FALSE, png = T, plotdir = here('model_runs','m0_3'))
SS_plots(m0_3, plot = FALSE, png = T, plotdir = here('model_runs','m0_3'))
SS_plots(m0_2, plot = F, png = T, plotdir = here('model_runs','m0_2'))
SS_plots(m0_1, plot = F,  png = T, plotdir = here('model_runs','m0_2'))
SS_plots(m0_2, png = T, plotdir = here('model_runs','m0_2'))
SS_plots(m0_3,   png = T, plotdir = here('model_runs','m0_3'))
?SS_plots
SS_plots(m0_3,   png = T, plotdir = here('model_runs','m0_3'))
# SS_plots(m0_3,   png = T, DIR =   here('model_runs','m0_3'))
SSplotComparisons(SSsummarize(list(m0_0,m0_1,m0_2,m0_3)),  plot = FALSE, png = T, plotdir = here('model_runs','m0_3'), uncertainty=TRUE,  legendlabels = models)
SS_plots(m0_3,   png = T, dir =   here('model_runs','m0_3'))
models = c('m0_0','+catch', '+survey', '+fish_len','+goa_len','+CAAL')
models = c('2017 Base','+catch', '+survey', '+fish_len','+goa_len','+CAAL')
# SS_plots(m0_1,    png = T, dir = here('model_runs','m0_1'))
SSplotComparisons(SSsummarize(list(m0_0,m0_1 )),  plot = FALSE, png = T, plotdir = here('model_runs','m0_1'), uncertainty=TRUE,  legendlabels = models)
# SS_plots(m0_2, png = T, dir = here('model_runs','m0_2'))
SSplotComparisons(SSsummarize(list(m0_0,m0_1,m0_2)),  plot = FALSE, png = T, plotdir = here('model_runs','m0_2'), uncertainty=TRUE,  legendlabels = models)
# SS_plots(m0_3,   png = T, dir =   here('model_runs','m0_3'))
SSplotComparisons(SSsummarize(list(m0_0,m0_1,m0_2,m0_3)),  plot = FALSE, png = T, plotdir = here('model_runs','m0_3'), uncertainty=TRUE,  legendlabels = models)
SS_plots(m0_0,    png = T, dir = here('model_runs','m0_0'))
?SSplotComps
SSplotComps(m0_3, subplot = 2, kind = 'LEN')
graphics.off()
SSplotComps(m0_3, subplot = 2, kind = 'LEN')
SSplotComps(m0_3,  kind = 'LEN')
SSplotComps(m0_3, subplot = 1, kind = 'LEN')
SSplotComps(m0_3, subplot = 3, kind = 'LEN')
SSplotComps(m0_3, fleet = 1, kind = 'LEN')
SSplotComps(m0_3, fleets = 1, kind = 'LEN')
SSplotComps(m0_3, fleets = 1, kind = 'LEN', subplot = 5)
SSplotComps(m0_3, fleets = 1, kind = 'LEN', subplot = 4)
SSplotComps(m0_3, fleets = 1, kind = 'LEN', subplot = 10)
SSplotComps(m0_3, fleets = 1, kind = 'LEN', subplot = 21)
SSplotComps(m0_3, fleets = 1, kind = 'LEN', subplot = 24)
SSplotComps(m0_3, fleets = 1, kind = 'LEN', subplot = 21)
m0_3 <- SS_output(here('model_runs','m0_3'), covar=TRUE, verbose=FALSE, printstats=FALSE)
# SS_plots(m0_3,   png = T, dir =   here('model_runs','m0_3'))
SSplotComparisons(SSsummarize(list(m0_0,m0_1,m0_2,m0_3)),  plot = FALSE, png = T, plotdir = here('model_runs','m0_3'), uncertainty=TRUE,  legendlabels = models)
SSplotComps(m0_3, fleets = 1, kind = 'LEN', subplot = 21)
SSplotComps(m0_3, fleets = 1, kind = 'LEN', subplot = 24)
SSplotComps(m0_3, fleets = 1, kind = 'LEN', subplot = 21)
SSplotComps(m0_3, fleets = 1, kind = 'LEN', subplot = 24)
here()
knitr::include_graphics(here('model_runs','m0_3','plots','comp_lenfit_residsflt1mkt0_page2.png'))
knitr::include_graphics(here('model_runs','m0_3','plots','comp_lenfit__aggregated_across_time.png'))
knitr::include_graphics(here('model_runs','m0_3','plots','comp_lenfit_residsflt1mkt0_page2.png'))
knitr::include_graphics(here('model_runs','m0_3','plots','comp_lenfit__aggregated_across_time.png'))
knitr::include_graphics(here('model_runs','m0_3','plots','comp_lenfit_residsflt1mkt0_page2.png'))
dim(fishery_length_comps)
library(readr)
goa_lcomp <- read_csv("data/comp/2022-04-20-goa_lengthcomp_forSS.csv")
View(goa_lcomp)
dim(goa_lcomp)
dim(fishery_length_comps)
names(fishery_length_comps)
names(goa_lcomp)
head(goa_lcomp)
head(fishery_length_comps)
class(goa_lcomp)
data.frame(goa_lcomp)
head(fishery_length_comps)
ncol(fishery_length_comps)
substr(names(goa_lcomp))
substr(names(goa_lcomp)1,3)
substr(names(goa_lcomp),1,3)
substr(names(fishery_length_comps),1,3)
length_bins
## comp data query
l.query<-paste0("SELECT GOA.SIZECOMP_TOTAL.SURVEY,\n ",
"GOA.SIZECOMP_TOTAL.YEAR,\n ",
"GOA.SIZECOMP_TOTAL.SPECIES_CODE,\n ",
"GOA.SIZECOMP_TOTAL.SUMMARY_AREA,\n ",
"GOA.SIZECOMP_TOTAL.LENGTH,\n ",
"GOA.SIZECOMP_TOTAL.MALES,\n ",
"GOA.SIZECOMP_TOTAL.FEMALES,\n ",
"GOA.SIZECOMP_TOTAL.UNSEXED,\n ",
"GOA.SIZECOMP_TOTAL.TOTAL\n ",
"FROM GOA.SIZECOMP_TOTAL\n ",
"WHERE GOA.SIZECOMP_TOTAL.SURVEY     = 'GOA'\n ",
"AND GOA.SIZECOMP_TOTAL.SPECIES_CODE = ",species)
Length_df<- sqlQuery(AFSC,l.query)
write.csv(Length_df,file = here('data','comp',paste0(Sys.Date(),'-goa_lengthcomp_raw.csv')),row.names = FALSE)
length_df_long <- Length_df %>%
mutate(LENGTH = LENGTH/10) %>% ## convert to cm
select(YEAR,LENGTH,MALES,FEMALES) %>%
melt(., id = c("YEAR","LENGTH")) %>%
BIN_LEN_DATA(.,length_bins) %>%
group_by(YEAR, variable, BIN) %>%
## combine observations within length bins
summarise(nobs = sum(value))
## get total number of samples in each year/sex/bin combo
length_df_long1 <- merge(length_df_long,
length_df_long %>%
group_by(YEAR) %>%
## denominator is total number of samples this year
summarise(nsamp = sum(nobs)),
by = c('YEAR')) %>%
# filter(YEAR == 1984 & BIN == 24)
## calculate frequencies
mutate(freq = nobs/nsamp,
variable = ifelse(variable == 'FEMALES', 1, 2)) %>%
select(-nobs, -nsamp) %>%
# ## fill missing year combos
tidyr::complete(., YEAR, variable, BIN) %>%
arrange(., YEAR, BIN, variable) %>%
mutate(freq = ifelse(is.na(freq),0,freq))
frontmatter <- data.frame(yr = unique(length_df_long1$YEAR), month = 7, fleet = 2, sex = 3, part = 0, Nsamp = nhauls$nhaul)
survey_length_comps <- cbind(frontmatter,
length_df_long1 %>%
filter(variable == 1) %>%
pivot_wider(., id_cols = YEAR, names_from = BIN, values_from = freq) %>%
select(-YEAR),
length_df_long1 %>%
filter(variable == 2) %>%
pivot_wider(., id_cols = YEAR, names_from = BIN, values_from = freq) %>%
select(-YEAR))
survey_length_comps
#* spot check survey lcomps ----
## should be within rounding range
mod17$lendbase %>%
filter(Fleet == 2 & Yr == 2001 & Bin == 10 & Sex == 1) %>%
select(Obs) %>% round(.,4) ==
round(survey_length_comps[7,'10'],4)
mod17$lendbase %>%
filter(Fleet == 2 & Yr == 2007 & Bin == 26 & Sex == 1) %>%
select(Obs) %>% round(.,4) ==
round(survey_length_comps[10,'26'],4)
write.csv(survey_length_comps,file = here('data','comp',paste0(Sys.Date(),'-goa_lengthcomp_forSS.csv')),row.names = FALSE)
names(survey_length_comps)
survey_length_comps
unique(length_df_long1$variable)
unique(length_df_long1$BIN)
unique(length_df_long$BIN)
length_df_long
mod17$lendbase %>%
filter(Fleet == 2 & Yr == 2001 & Bin == 60 & Sex == 1)
mod17$lendbase %>%
filter(Fleet == 2 & Yr == 2001 & Bin == 60 & Sex == 1) %>%
select(Obs) %>% round(.,4)
mod17$lendbase %>%
filter(Fleet == 2 & Bin == 60 & Sex == 1)
levels(length_df_long$BIN)
length_df_long <- Length_df %>%
mutate(LENGTH = LENGTH/10) %>% ## convert to cm
select(YEAR,LENGTH,MALES,FEMALES) %>%
melt(., id = c("YEAR","LENGTH")) %>%
BIN_LEN_DATA(.,length_bins) %>%
group_by(YEAR, variable, BIN) %>%
## combine observations within length bins
summarise(nobs = sum(value))
length_df_long$BIN <- factor(length_df_long$BIN, levels = age_bins)
length_df_long$BIN
length_df_long
unique(length_df_long$BIN)
## get total number of samples in each year/sex/bin combo
length_df_long1 <- merge(length_df_long,
length_df_long %>%
group_by(YEAR) %>%
## denominator is total number of samples this year
summarise(nsamp = sum(nobs)),
by = c('YEAR')) %>%
# filter(YEAR == 1984 & BIN == 24)
## calculate frequencies
mutate(freq = nobs/nsamp,
variable = ifelse(variable == 'FEMALES', 1, 2)) %>%
select(-nobs, -nsamp) %>%
# ## fill missing year combos
tidyr::complete(., YEAR, variable, BIN) %>%
arrange(., YEAR, BIN, variable) %>%
mutate(freq = ifelse(is.na(freq),0,freq))
frontmatter <- data.frame(yr = unique(length_df_long1$YEAR), month = 7, fleet = 2, sex = 3, part = 0, Nsamp = nhauls$nhaul)
survey_length_comps <- cbind(frontmatter,
length_df_long1 %>%
filter(variable == 1) %>%
pivot_wider(., id_cols = YEAR, names_from = BIN, values_from = freq) %>%
select(-YEAR),
length_df_long1 %>%
filter(variable == 2) %>%
pivot_wider(., id_cols = YEAR, names_from = BIN, values_from = freq) %>%
select(-YEAR))
unique(length_df_long$BIN)
length_df_long <- Length_df %>%
mutate(LENGTH = LENGTH/10) %>% ## convert to cm
select(YEAR,LENGTH,MALES,FEMALES) %>%
melt(., id = c("YEAR","LENGTH")) %>%
BIN_LEN_DATA(.,length_bins) %>%
group_by(YEAR, variable, BIN) %>%
## combine observations within length bins
summarise(nobs = sum(value)) %>%
rbind()
unique(length_df_long$BIN)
