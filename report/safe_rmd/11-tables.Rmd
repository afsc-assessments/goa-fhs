# Tables


 

```{r catchbyarea, echo = FALSE, warning = FALSE, message = FALSE}
catch <-   bind_rows(read.csv(here('data','catch',paste0('2022-04-18-catch_forSS.csv'))) %>%
  filter(yr < 1991) %>% select(YEAR = yr, "TTONS" = catch_mt) %>%
  mutate("WGULF" = NA, "CG" = NA, "EGULF" = NA ),
read.csv(here('data','catch',paste0('2022-04-18-catch-byArea.csv'))) %>%
 rowwise() %>% 
  mutate(TTONS = sum(WGULF,CG,EGULF, na.rm=TRUE)) %>% data.frame() )




catch[catch < 1&!is.na(catch)] <- round(catch[catch < 1 & !is.na(catch)],2)
catch[catch > 1&!is.na(catch)] <- round(catch[catch > 1 & !is.na(catch)],0)
catch$YEAR <- as.character(catch$YEAR) 

names(catch) <- c('Year','Total Catch (mt)','Western Gulf','Central Gulf','Eastern Gulf')
flextable::regulartable(catch) %>%  
      flextable::set_caption(paste0("Total and regional annual catch of GOA Flathead sole through ", date,". Data are from NMFS Observer Program and Alaska Regional Office.")) %>%
  flextable::colformat_num(big.mark = ",")
```

```{r catchvsharvest, echo = FALSE, warning = FALSE, message = FALSE}

spex <- read.csv(here::here('data','catch',paste0('2022-09-29-harvestSpex.csv'))) %>%
  tidyr::pivot_wider(., id_cols = 'Yr',names_from = variable, values_from = value) %>%
  filter(Yr > 1994)

## manually reshape the raw catches for discard/retained percentage
catch_discard <- read.csv(here::here('data','catch',paste0('2022-04-18-catch-raw.csv'))) %>%
  # merge(., spex, by.x = 'YEAR', by.y ='Yr') %>%
  filter(TYPE == 'D') %>%
  group_by(YEAR) %>%
  dplyr::summarise(discT = sum(TONS) )

spex2 <- merge(catch_discard, spex, by.x = 'YEAR', by.y ='Yr') %>%
  mutate( "Total Catch" = round(Catch,0),
          catchRet = 100*round(1-discT/Catch,2) )%>%
  select(Year = YEAR, OFL, ABC, TAC, "Total Catch"  , "% Retained" = catchRet)  
spex2$Year <- as.character(spex2$Year)        
  
flextable::regulartable(spex2) %>%  
      flextable::set_caption(paste0("Historical OFLs, ABCs, TACs, total catch and percent retention through ", date,".")) %>%
  flextable::colformat_num(big.mark = ",")
```

\pagebreak

```{r tab3, echo = FALSE, warning = FALSE, message = FALSE}
mgmtaction <- read.csv(here('tables','table3_closures.csv'))

flextable::regulartable(mgmtaction) %>%  
      flextable::set_caption("GOA Flathead sole fishery closures in 2015.")
```

\pagebreak


```{r tab4survbioareadepth, echo = FALSE, warning = FALSE, message = FALSE}
survArea <- read.csv(here('data','survey','2022-04-18-index_by_area.csv'))

flextable::regulartable(mgmtaction) %>%  
      flextable::set_caption("Survey biomass by area and depth.")
```


```{r tab5inputsurv, echo = FALSE, warning = FALSE, message = FALSE}
survSS <- read.csv(here('data','survey','2022-04-18-index_forSS.csv')) %>%
  select(-month, -fleet, Year = yr, 'Observed Biomass (t)' = obs, 'CV' = sterr) 

survSS[survSS < 1&!is.na(survSS)] <- round(survSS[survSS < 1 & !is.na(survSS)],2)
survSS[survSS > 1&!is.na(survSS)] <- round(survSS[survSS > 1 & !is.na(survSS)],0)
survSS$Year <- as.character(survSS$Year)


flextable::regulartable(survSS) %>%  
      flextable::set_caption("Survey biomass estimates and CVs used in the assessment as an absolute index of abundance.")
```

```{r tab6selex, echo = FALSE, warning = FALSE, message = FALSE}
survSS <- read.csv(here('tables','table6_selex.csv')) 

flextable::regulartable(survSS) %>%  
      flextable::set_caption("Treatment of selectivity parameters for survey and fishery fleet. Bracketed values indicate parameter bounds, if applicable.") %>%
  flextable::width(.,j=1,width=3) %>%
   flextable::width(.,j=2:3,width=2)
```


```{r likelihoodcomponents, echo = FALSE, warning = FALSE, message = FALSE}
m17like <- m2017$likelihoods_used %>%
  mutate(component = rownames(.)) %>%
  filter(component %in% c('TOTAL','Survey','Length_comp','Age_comp','Recruitment')) %>%
  select(component, 'Model 17.0 (2017)' = values)


m02 <- SS_output(here('model_runs','01_bridging','cole','m02_2017_3.30.17'), covar=TRUE, verbose=FALSE, printstats=FALSE)
bridgelike <- m02$likelihoods_used %>%
  mutate(component = rownames(.)) %>%
  filter(component %in% c('TOTAL','Survey','Length_comp','Age_comp','Recruitment')) %>%
  select( 'Model 17.1a (2022) with 2017 data' = values)

baselike <- base_model$likelihoods_used %>%
  mutate(component = rownames(.)) %>%
  filter(component %in% c('TOTAL','Survey','Length_comp','Age_comp','Recruitment')) %>%
  select( 'Model 17.1a (2022)' = values)

flextable::regulartable(bind_cols(m17like, bridgelike,baselike)) %>%  
      flextable::set_caption("Likelihood components for the base case 2022 model, the base case model with new data removed (data are as for the 2015 model), and the 2017 model. Values for likelihood components for the 2022 base case model cannot be compared directly with the other two models. The likelihoods for the 2017 model and the 2022 model with 2017 data vary slightly due to changes in the underlying software.") 
```


```{r parestgrowth, echo = FALSE, warning = FALSE, message = FALSE}
 # Final parameter estimates of growth parameters and unfished recruitment with corresponding standard deviations for the 2017 base case model, the 2017 base case model with data up to 2015, and the 2015 model.
```


```{r parestselexfish, echo = FALSE, warning = FALSE, message = FALSE}
 # Final fishery selectivity parameters for the 2017 base case model, the 2017 model with data up to 2015, and the 2015 model. “Est” refers to the estimated value and “Std. Dev” is the standard deviation of the estimate.  Parameters with NA for Std. Dev. are not estimated.
```


```{r parestselexsurv, echo = FALSE, warning = FALSE, message = FALSE}
 # Final fishery selectivity parameters for the 2017 base case model, the 2017 model with data up to 2015, and the 2015 model. “Est” refers to the estimated value and “Std. Dev” is the standard deviation of the estimate.  Parameters with NA for Std. Dev. are not estimated.
```

```{r frates, echo = FALSE, warning = FALSE, message = FALSE}
 # Estimated yearly fishing mortality rates (rates are apical fishing mortality rates across ages) for the proposed 2017 model.
```

```{r recdevs, echo = FALSE, warning = FALSE, message = FALSE}
 # Recruitment deviations and standard deviations for the proposed 2017 model.
```


```{r ssbts, echo = FALSE, warning = FALSE, message = FALSE}
# Table 13. Time series of total (age 3+) and spawning biomass and standard deviation of spawning biomass (Std_Dev) for the previous and proposed 2017 assessments.
```


```{r rects, echo = FALSE, warning = FALSE, message = FALSE}
# TTime series of recruitment at ages 3 and 0 and standard deviation of age 0 recruits for the previous and proposed 2017 assessments.
```



```{r projSB, echo = FALSE, warning = FALSE, message = FALSE}
# Projected spawning biomass for the seven harvest scenarios listed in the “Harvest Recommendations” section.
```

```{r projF, echo = FALSE, warning = FALSE, message = FALSE}
#  Projected fishing mortality rates for the seven harvest scenarios listed in the “Harvest Recommendations” section.
```

```{r projcatch, echo = FALSE, warning = FALSE, message = FALSE}
# Projected catches for the seven harvest scenarios listed in the “Harvest Recommendations” section.
```


```{r nontarg, echo = FALSE, warning = FALSE, message = FALSE}
# Non-target catch in the directed GOA flathead sole fishery as a proportion of total weight of bycatch of each species. Conditional highlighting from white (lowest numbers) to green (highest numbers) is applied. No seabird bycatch was recorded in the GOA flathead sole fishery.
```

```{r prohibcath, echo = FALSE, warning = FALSE, message = FALSE}
# Prohibited species catch caught in the GOA flathead sole fishery in 2015, 2016 and 2017.
```