---
title: "GOA Flathead sole sensitivity runs 2022"
author:  Maia Sosa Kapur maia.kapur@noaa.gov
format:
  html:
    self-contained: true
toc: true
code-fold: true
code-overflow: wrap
execute: 
  warning: false 
theme: yeti
editor: source
---


```{r setup, echo = FALSE, include = FALSE}
require(here)
require(r4ss)
require(dplyr)
base_model <- SS_output(here('model_runs','m0_8-newMI-biasAdj'), covar=TRUE, verbose=FALSE, printstats=FALSE) 
esth <- SS_output(here('model_runs','m0_8-newMI-biasadj-estH'))
```

This document contains the sensitivity runs mentioned in the "responses to SSC..." and "data gaps and future research" sections of the 2022 SAFE. Because they are not presented as alternative models, we elected to provide these as online, supplementary material. Qualitative descriptions of these explorations are retained in the SAFE text.

## Sensitivity Runs indicated by SSC/CIE comments

### Truncate survey data before 1993

::: panel-tabset
## Biomass

```{r, echo=FALSE, fig.cap="The SSB time series are basically identical during the period of shared data."}
knitr::include_graphics(here('model_runs','m0_8-newMI-biasAdj-srv1993','compare2_spawnbio_uncertainty.png'))
```

## Rec Deviations
```{r echo=FALSE, fig.cap="The deviations take longer to be informed in the truncated model."}
knitr::include_graphics(here('model_runs','m0_8-newMI-biasAdj-srv1993','compare11_recdevs.png'))
```
## Survey Fits

```{r, echo=FALSE, fig.cap="The survey fits are basically identical during the period of shared data."}
knitr::include_graphics(here('model_runs','m0_8-newMI-biasAdj-srv1993','compare13_indices.png'))
```
:::

### Begin recruitment deviations in 1983



::: panel-tabset
## Biomass

```{r echo=FALSE, fig.cap="The SSB time series are much higher in the early period (when using mean recruitment), yet end at a slightly lower value. This likely has to do with the mean-zero penalty on deviations."}
knitr::include_graphics(here('model_runs','m0_8-newMI-biasAdj-devs1983','compare2_spawnbio_uncertainty.png'))
```

## Age-0 Recruits
```{r, echo=FALSE, fig.cap="The recruitment series follows a similar trend, though the later-start model estimates recruits as systematically lower for the last ~15 years."}
knitr::include_graphics(here('model_runs','m0_8-newMI-biasAdj-devs1983','compare10_recruits_uncertainty.png'))
```
## Survey Fits

```{r, echo=FALSE, fig.cap="The later-start model fits the first and third survey year better, and reflects a less positive trend (more neutral or flat) than the base model."}
knitr::include_graphics(here('model_runs','m0_8-newMI-biasAdj-devs1983','compare13_indices.png'))
```
:::


### Analytical or estimated survey catchability (q)
Two sensitivities here: one where $q$ was allowed to be estimated between -15 and 15, and another where it was calculated analytically from the survey observations. In both cases, the resultant value for $q$ was 1.65, which is slightly higher than the value suggested by the likelihood profile.

::: panel-tabset

## Biomass

```{r, echo=FALSE, fig.cap="The SSB time series is much smaller when q is allowed to be estimated or calculated analytically, but was consistent between the two models where q was not fixed to 1."}
knitr::include_graphics(here('model_runs','m0_8-newMI-biasAdj-estq','compare2_spawnbio_uncertainty.png'))
```

## BRatio

```{r, echo=FALSE, fig.cap="Though the time series are distinct, the qualitative status of both models is roughly similar. Note there is an inaccuracy in the y-axis labels generated by r4ss; the SSB series is not actually above B0, rather, the Bratios are auto-calculated with respect to B35 (grey dashed line)."}
knitr::include_graphics(here('model_runs','m0_8-newMI-biasAdj-estq','compare4_Bratio_uncertainty.png'))
```

## Rec Deviations
```{r, echo=FALSE, fig.cap="Overall the dev trends are similar between models, but the models with q not fixed at 1 are more conservative (have smaller devs) in recent years."}
knitr::include_graphics(here('model_runs','m0_8-newMI-biasAdj-estq','compare11_recdevs.png'))
```
## Survey Fits

```{r, echo=FALSE, fig.cap="Models with q estimated/calculated analytically do a slightly better job fitting the survey data, specifically the decline in the last two years (they cross the CI, at the expense of underfitting the previous ~3 years). My suspicion is that there are some changes in catchability and/or selectivity which aren't represented in out model, because the fitted trend is quite flat. Alternatively, it's possible that the population truly is quite stable and our representation of observation error is simply too narrow."}
knitr::include_graphics(here('model_runs','m0_8-newMI-biasAdj-estq','compare13_indices.png'))
```

:::

## Additional Sensitivity runs

### Unweighted Model

This model has no data weights on any source, so the input sample sizes for the compositional data are taken as-is. Specifically, the survey length compositions have much higher input sample sizes than the fishery.

::: panel-tabset
## Input Sample Sizes

```{r, echo=FALSE, fig.cap="The input sample sizes, shown here as the total annual number of hauls, favors the survey length composition data. In the base data weighting exercise, both of these datasets are up-weighted (with variance adjustments greater than 1), the Fishery to a greater extent."}
knitr::include_graphics(here('figs','Nsamp_in_length.png'))
```

## Biomass
```{r, echo=FALSE, fig.cap="Without any data weighting, the SSB trend is orders of magnitude lower than the base model. This suggests that up-weighting the length composition data is the main driver of the model scale."}
knitr::include_graphics(here('model_runs','m0_8c','compare2_spawnbio_uncertainty.png'))
```

## Bratio and R0

```{r, echo=FALSE, fig.cap="The Bratios are qualitatively similar, but the unweighted model has much lower estimate for R0. This suggests that the length composition data are the main drivers of the model scale. Note there is an inaccuracy in the y-axis labels generated by r4ss; the SSB series is not actually above B0, rather, the Bratios are auto-calculated with respect to B35 (grey dashed line).", out.width="50%"}
knitr::include_graphics(here('model_runs','m0_8c','compare4_bratio_uncertainty.png'))


knitr::include_graphics(here('model_runs','m0_8c','compare16_densities_sr_ln(R0).png'))
```
## Rec Deviations
```{r, echo=FALSE, fig.cap="Recruitment deviations vary slightly among approaches; the unweighted model favors more higher recruitment years in the early period, but generally is up and down during the same years as the base."}
knitr::include_graphics(here('model_runs','m0_8c','compare12_recdevs_uncertainty.png'))
```
## Survey Fits
```{r, echo=FALSE, fig.cap="The unweighted model cannot even enter the ballpark of the survey data, likely because q is fixed to 1."}
knitr::include_graphics(here('model_runs','m0_8c','compare13_indices.png'))
```
:::


### Francis weights instead of McCallister-Ianelli
The Francis weights are much lower overall than those suggested by M-I, downweighting all components.

::: panel-tabset

## Suggested Francis Weights
```{r, echo=FALSE}
## show the values suggested after unweighted model
m0_8_newFrancis <- SS_output(here::here('model_runs','m0_8-newFrancis'), verbose = FALSE, printstats = FALSE)
tune_comps(m0_8_newFrancis, 
              option = 'Francis',
              niters_tuning = 0,
              allow_up_tuning = TRUE,
              write = F,
              dir = here::here('model_runs','m0_8-NewFrancis')) %>%
  select(Name, Type, 'Suggested Francis Weights' = Old_Var_adj)
```

## Biomass

```{r, echo=FALSE, fig.cap="The choice of weighting method does not greatly change the SSB time series, though the Francis data suggest a flatter trend."}
knitr::include_graphics(here::here('model_runs','m0_8-newfrancis','compare2_spawnbio_uncertainty.png'))
```

## Rec Deviations
```{r, echo=FALSE, fig.cap="Overall the dev trends are similar between models, but the Francis weighted estimate models are more conservative (smaller devs) in recent years."}
knitr::include_graphics(here::here('model_runs','m0_8-newfrancis','compare11_recdevs.png'))
```
## Survey Fits

```{r, echo=FALSE, fig.cap="The model with the Francis weights do a slightly better job fitting the survey data."}
knitr::include_graphics(here('model_runs','m0_8-newfrancis','compare13_indices.png'))
```

## Length Comp Fits

```{r, echo=FALSE, fig.cap="The length comp fits are not strikingly different between weighting approaches (1).", out.width="50%"}
knitr::include_graphics(here('model_runs','m0_8-newMI-biasAdj','plots','comp_lenfit__aggregated_across_time.png'))

```

```{r, echo=FALSE, fig.cap="The length comp fits are not strikingly different between weighting approaches (2).", out.width="50%"}
knitr::include_graphics(here('model_runs','m0_8-newfrancis','plots','comp_lenfit__aggregated_across_time.png'))
```


:::

### Previous ageing error matrix

Outputs from this approach can be found at the bottom of [this page](https://mkapur-noaa.github.io/goa-fhs-2022/AgeingError_Writeup_Static.html).

### Estimate steepness
H was allowed to be estimated and landed right at 0.99, so the resultant outputs are indistinguishable from the original model (with it fixed). It's hard to say at this point whether we have or do not have evidence for density dependence, particularly because this species is so lightly exploited. For now I am OK with leaving the steepness as-is.

::: panel-tabset

## Par Est

```{r, echo=FALSE, fig.cap="Steepness was estimated at 0.99, with basically no change in the estimate of R0."}

# esth$parameters[esth$parameters$Label == 'SR_BH_steep',]
# esth$parameters[esth$parameters$Label == 'SR_LN(R0)',]
# base_model$parameters[base_model$parameters$Label == 'SR_BH_steep',]
# base_model$parameters[base_model$parameters$Label == 'SR_LN(R0)',]
SSplotPars(esth,strings = c("steep", "R0"))
# SSplotPars(base_model,strings = c("steep", "R0"))


```

## Biomass

```{r, echo=FALSE, fig.cap="No change in SSB timeseries with h estimated."}
knitr::include_graphics(here('model_runs','m0_8-newMI-biasAdj-estH','compare2_spawnbio_uncertainty.png'))
```

## Rec Deviations

```{r, echo=FALSE, fig.cap="No change in dev trends with h estimated."}
knitr::include_graphics(here('model_runs','m0_8-newMI-biasadj-estH','compare11_recdevs.png'))
```

## Survey Fits

```{r, echo=FALSE, fig.cap="No change in survey fits with h estimated."}
knitr::include_graphics(here('model_runs','m0_8-newMI-biasadj-estH','compare13_indices.png'))
```
:::

